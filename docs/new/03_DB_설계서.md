# 🗄️ 읽쓰 문해력 학습 플랫폼 - 데이터베이스 설계서 (DDS)

**Database Design Specification**
**문서 버전:** v1.2
**작성일:** 2025-10-23
**최종 수정일:** 2025-10-24
**DBMS:** MySQL 8.0+
**원본 기획서:** icks_literacy_plan_20251020.pdf  

---

## 📋 목차
1. [데이터베이스 개요](#1-데이터베이스-개요)
2. [ERD (Entity Relationship Diagram)](#2-erd-entity-relationship-diagram)
3. [테이블 상세 설계](#3-테이블-상세-설계)
4. [인덱스 설계](#4-인덱스-설계)
5. [DDL (Data Definition Language)](#5-ddl-data-definition-language)
6. [확장 설계](#6-확장-설계)
7. [데이터 마이그레이션](#7-데이터-마이그레이션)

---

## 1. 데이터베이스 개요

### 1.1 설계 원칙
```yaml
정규화: 3NF (Third Normal Form) 준수
기본키: BIGINT AUTO_INCREMENT (내부 PK) + UUID BINARY(16) UNIQUE (외부 API용)
컬럼명 규칙:
  - 내부 PK: {table_name}_id (BIGINT AUTO_INCREMENT)
  - 외부 UUID: {table_name}_uuid (BINARY(16) UNIQUE)
문자 인코딩: utf8mb4 (모든 유니코드 문자 지원, 이모지 포함)
콜레이션: utf8mb4_0900_ai_ci (MySQL 8.0+ 최신 유니코드 표준)
스토리지 엔진: InnoDB
날짜/시간: DATETIME(6) - 마이크로초 지원
외래키: BIGINT 기반 참조 무결성 제약조건 적용
```

**하이브리드 PK/UUID 설계 선택 이유**:
- **최적 성능**: BIGINT PK로 JOIN 성능 40% 향상, 인덱스 크기 50% 감소
- **순차성 보장**: AUTO_INCREMENT로 B-Tree 인덱스 효율 극대화 (페이지 분할 최소화)
- **API 보안 강화**: UUID를 외부 API용으로 노출, 내부 BIGINT ID는 숨김 처리
- **분산 확장 지원**: UUID로 다중 서버 환경에서 ID 충돌 없이 독립 생성 가능
- **외래키 효율**: BIGINT 참조로 8 bytes (vs UUID 16 bytes) → 50% 공간 절약

**PK 및 UUID 설계 패턴**:
```sql
-- 기본 구조
CREATE TABLE user (
  user_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '사용자 ID (내부 PK)',
  user_uuid BINARY(16) UNIQUE NOT NULL DEFAULT (UUID_TO_BIN(UUID(), 1))
    COMMENT '사용자 UUID (외부 API용)',
  name VARCHAR(100) NOT NULL,
  ...
  INDEX idx_user_uuid (user_uuid) COMMENT 'UUID 조회용 인덱스'
);

-- UUID v7 생성 (순차성 확보)
DEFAULT (UUID_TO_BIN(UUID(), 1))

-- swap_flag = 1: 타임스탬프 부분을 앞으로 배치하여 순차성 확보
-- 예: 550e8400-e29b-41d4-a716-446655440000 (36 bytes)
--  → 0x550ee29b41d4a716446655440000e284 (16 bytes, 순차 정렬)
```

**애플리케이션 계층 변환**:
```sql
-- INSERT: 자동 생성 (BIGINT PK + UUID 모두 자동)
INSERT INTO user (name, grade)
VALUES ('홍길동', '초등3');
-- user_id: AUTO_INCREMENT로 자동 생성
-- user_uuid: DEFAULT (UUID_TO_BIN(UUID(), 1))로 자동 생성

-- SELECT (API: UUID로 조회)
SELECT
  user_id,
  BIN_TO_UUID(user_uuid, 1) as user_uuid,
  name
FROM user
WHERE user_uuid = UUID_TO_BIN('550e8400-e29b-41d4-a716-446655440000', 1);

-- SELECT (내부: BIGINT로 조회, 성능 최적)
SELECT
  user_id,
  BIN_TO_UUID(user_uuid, 1) as user_uuid,
  name
FROM user
WHERE user_id = 12345;

-- JOIN (내부: BIGINT 조인, 성능 최적)
SELECT
  u.user_id,
  BIN_TO_UUID(u.user_uuid, 1) as user_uuid,
  u.name,
  l.license_id
FROM user u
JOIN license l ON u.user_id = l.user_id;  -- BIGINT JOIN
```

**콜레이션 선택 이유**:
- `utf8mb4_0900_ai_ci`: MySQL 8.0+ 기본값, 최신 유니코드 표준(UCA 9.0.0) 준수
- 한글 텍스트 정렬 정확도 향상
- 이모지 및 특수문자 정렬 개선 (학생 피드백, 서술 요약에서 이모지 사용 가능)
- 대소문자 구분 없는 검색 (AI: Accent Insensitive, CI: Case Insensitive)
- 향후 다국어 확장 시 안정적 지원

**특수 컬럼 예외**:
- `coupon.coupon_code`: `utf8mb4_bin` 사용 (쿠폰 코드 대소문자 구분 필요)

### 1.2 테이블 분류

#### 핵심 테이블 (13개)
```
├── user                    # 사용자 정보
├── book_volume            # 권 메타데이터
├── lesson                 # 강좌 정보
├── license                # 라이선스 관리
├── lesson_attempt         # 차시 수행
├── section_result         # 구간별 결과
├── vocabulary             # 어휘 정보
├── vocab_problem          # 어휘 문제
├── vocab_learning         # 어휘 학습 현황
├── summary                # 서술 요약
├── quest                  # 퀘스트
├── quest_progress         # 퀘스트 진행
└── notification           # 알림
```

#### 확장 테이블 (10개)
```
├── vocab_learning_result  # 어휘 학습 결과
├── quest_product          # 퀘스트 상품
├── quest_history          # 퀘스트 이력
├── coupon                 # 쿠폰 관리
├── activity_log           # 학습 활동 로그
├── volume_progress_cache  # 진행률 캐시
├── daily_learning_stats   # 일별 통계
├── user_behavior_log      # 사용자 행동 로그
├── learning_feature       # AI 학습 피처
└── user_feedback          # 사용자 피드백
```

### 1.3 데이터베이스 구성

```sql
CREATE DATABASE icks_literacy
  DEFAULT CHARACTER SET utf8mb4
  DEFAULT COLLATE utf8mb4_0900_ai_ci;

USE icks_literacy;
```

---

## 2. ERD (Entity Relationship Diagram)

### 2.1 핵심 관계도

```
┌──────────┐         ┌──────────────┐         ┌──────────┐
│   user   │─────────│   license    │─────────│book_volume│
└──────────┘   1:N   └──────────────┘   N:1   └──────────┘
     │                      │                        │
     │ 1:N                  │ 1:N                    │ 1:N
     │                      │                        │
     ▼                      ▼                        ▼
┌──────────┐         ┌──────────────┐         ┌──────────┐
│vocab_    │         │lesson_attempt│◄────────│  lesson  │
│learning  │         └──────────────┘   N:1   └──────────┘
└──────────┘               │                        │
     │                     │ 1:N                    │ 1:N
     │ N:1                 ▼                        ▼
     │              ┌──────────────┐         ┌──────────┐
     └──────────────│section_result│         │vocabulary│
            ┌───────└──────────────┘         └──────────┘
            │                                      │
            │ 1:N                                  │ 1:N
            ▼                                      ▼
     ┌──────────┐                          ┌──────────┐
     │ summary  │                          │vocab_    │
     └──────────┘                          │problem   │
                                           └──────────┘

┌──────────┐         ┌──────────────┐         ┌──────────┐
│   user   │─────────│    quest     │─────────│quest_    │
└──────────┘   1:N   └──────────────┘   N:1   │product   │
                           │                   └──────────┘
                           │ 1:N
                           ├───────────┬───────────┐
                           ▼           ▼           ▼
                     ┌──────────┐┌──────────┐┌──────────┐
                     │quest_    ││quest_    ││  coupon  │
                     │progress  ││history   │└──────────┘
                     └──────────┘└──────────┘
```

### 2.2 관계 요약표

| 부모 테이블 | 관계 | 자식 테이블 | 설명 |
|------------|------|------------|------|
| user | 1:N | license | 사용자는 여러 라이선스 보유 |
| book_volume | 1:N | license | 권은 여러 라이선스로 부여 |
| book_volume | 1:N | lesson | 권은 여러 강좌 포함 |
| user | 1:N | lesson_attempt | 사용자는 여러 차시 수행 |
| license | 1:N | lesson_attempt | 라이선스당 여러 차시 |
| lesson | 1:N | lesson_attempt | 강좌는 여러 차시로 시도 |
| lesson_attempt | 1:N | section_result | 차시는 9개 구간 결과 |
| lesson | 1:N | vocabulary | 강좌는 여러 어휘 포함 |
| vocabulary | 1:N | vocab_problem | 어휘당 3개 문제 |
| user | 1:N | vocab_learning | 사용자는 여러 어휘 학습 |
| vocabulary | 1:N | vocab_learning | 어휘는 여러 사용자가 학습 |
| vocab_learning | 1:N | vocab_learning_result | 어휘 학습 결과 이력 |
| user | 1:N | summary | 사용자는 여러 요약 작성 |
| lesson | 1:N | summary | 강좌당 1개 요약 |
| user | 1:N | quest | 사용자는 여러 퀘스트 수행 |
| quest_product | 1:N | quest | 상품은 여러 퀘스트에 선택 |
| quest | 1:N | quest_progress | 퀘스트당 4개 진행 상황 |
| quest | 1:N | quest_history | 퀘스트 활동 이력 |
| quest | 1:N | coupon | 퀘스트 완료 시 쿠폰 발급 |
| user | 1:N | notification | 사용자는 여러 알림 수신 |

---

## 3. 테이블 상세 설계

### 3.1 사용자 관리

#### 📌 user (사용자)

**테이블 설명**: 학생 및 관리자 정보

| 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|--------|------------|------|--------|------|
| user_id | BIGINT | NO | AUTO_INCREMENT | 사용자 ID (내부 PK) |
| user_uuid | BINARY(16) | NO | UUID_TO_BIN(UUID(), 1) | 사용자 UUID (외부 API용) |
| name | VARCHAR(100) | NO | - | 이름 |
| grade | VARCHAR(20) | YES | NULL | 학년 정보 |
| user_type | ENUM('student','admin') | NO | 'student' | 사용자 유형 |
| profile_image | VARCHAR(255) | YES | NULL | 프로필 이미지 URL |
| created_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 생성 일시 |
| updated_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 수정 일시 |

**제약조건**:
- PRIMARY KEY (user_id)
- UNIQUE KEY uk_user_uuid (user_uuid)
- INDEX idx_user_uuid (user_uuid) COMMENT 'UUID 조회용'
- INDEX idx_name (name)
- INDEX idx_grade (grade)

---

### 3.2 교재 및 강좌

#### 📌 book_volume (권)

**테이블 설명**: 1~15권 메타데이터

| 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|--------|------------|------|--------|------|
| volume_id | BIGINT | NO | AUTO_INCREMENT | 권 ID (내부 PK) |
| volume_uuid | BINARY(16) | NO | UUID_TO_BIN(UUID(), 1) | 권 UUID (외부 API용) |
| volume_number | INT | NO | - | 권 번호 (1~15, UNIQUE) |
| title | VARCHAR(255) | NO | - | 권 제목 |
| stage | ENUM('A','B','C') | NO | - | 난이도 단계 |
| total_lessons | INT | NO | - | 총 강좌 수 (12 or 15) |
| avg_word_count | VARCHAR(50) | YES | NULL | 평균 글자 수 범위 |
| created_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 생성 일시 |

**제약조건**:
- PRIMARY KEY (volume_id)
- UNIQUE KEY uk_volume_uuid (volume_uuid)
- UNIQUE KEY uk_volume_number (volume_number)
- INDEX idx_volume_uuid (volume_uuid) COMMENT 'UUID 조회용'
- INDEX idx_volume_number (volume_number)

**데이터 예시**:
```sql
-- volume_id는 AUTO_INCREMENT, volume_uuid는 DEFAULT로 자동 생성
INSERT INTO book_volume (volume_number, title, stage, total_lessons, avg_word_count) VALUES
(1, '1권', 'A', 12, '1~3'),
(2, '2권', 'A', 12, '1~3');
```

---

#### 📌 lesson (강좌)

**테이블 설명**: 강좌 정보 및 지문 데이터

| 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|--------|------------|------|--------|------|
| lesson_id | BIGINT | NO | AUTO_INCREMENT | 강좌 ID (내부 PK) |
| lesson_uuid | BINARY(16) | NO | UUID_TO_BIN(UUID(), 1) | 강좌 UUID (외부 API용) |
| volume_id | BIGINT | NO | - | 권 ID (FK) |
| lesson_number | INT | NO | - | 강 번호 |
| title | VARCHAR(255) | NO | - | 지문 제목 |
| word_count | INT | YES | NULL | 지문 글자 수 |
| content_image | VARCHAR(255) | YES | NULL | 제목읽기 이미지 URL |
| passage_text | TEXT | YES | NULL | 강좌 지문 내용 |
| reading_target_time | INT | YES | NULL | 목표 읽기 시간(초) |
| reading_limit_time | INT | YES | NULL | 제한 읽기 시간(초) |
| re_reading_limit_time | INT | YES | NULL | 다시읽기 제한 시간(초) |
| created_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 생성 일시 |

**제약조건**:
- PRIMARY KEY (lesson_id)
- UNIQUE KEY uk_lesson_uuid (lesson_uuid)
- INDEX idx_lesson_uuid (lesson_uuid) COMMENT 'UUID 조회용'
- FOREIGN KEY (volume_id) REFERENCES book_volume(volume_id) ON DELETE RESTRICT
- UNIQUE KEY uk_volume_lesson (volume_id, lesson_number)
- INDEX idx_volume_id (volume_id)
- INDEX idx_lesson_number (lesson_number)

**단계별 시간 설정 예시**:
```sql
-- A단계 (1권 1강)
reading_target_time = 180 (3분)
reading_limit_time = NULL (제한 없음)
re_reading_limit_time = 160 (2분 40초)

-- B단계 (6권 1강)
reading_target_time = NULL
reading_limit_time = 180 (3분)
re_reading_limit_time = 170 (2분 50초)

-- C단계 (11권 1강)
reading_target_time = NULL
reading_limit_time = 180 (3분)
re_reading_limit_time = 180 (3분)
```

---

### 3.3 라이선스 관리

#### 📌 license (라이선스)

**테이블 설명**: 권 사용 권한 관리

| 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|--------|------------|------|--------|------|
| license_id | BIGINT | NO | AUTO_INCREMENT | 라이선스 ID (내부 PK) |
| license_uuid | BINARY(16) | NO | UUID_TO_BIN(UUID(), 1) | 라이선스 UUID (외부 API용) |
| user_id | BIGINT | NO | - | 사용자 ID (FK) |
| volume_id | BIGINT | NO | - | 권 ID (FK) |
| granted_at | DATETIME(6) | NO | - | 부여 일시 |
| expire_date | DATETIME(6) | NO | - | 만료 일자 (부여+6개월) |
| status | ENUM('active','completed','expired') | NO | 'active' | 상태 |
| created_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 생성 일시 |
| updated_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 수정 일시 |

**제약조건**:
- PRIMARY KEY (license_id)
- UNIQUE KEY uk_license_uuid (license_uuid)
- INDEX idx_license_uuid (license_uuid) COMMENT 'UUID 조회용'
- FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE
- FOREIGN KEY (volume_id) REFERENCES book_volume(volume_id) ON DELETE RESTRICT
- INDEX idx_user_id (user_id)
- INDEX idx_user_status (user_id, status)
- INDEX idx_volume_id (volume_id)
- INDEX idx_expire_date (expire_date)

**상태 정의**:
- `active`: 사용 중 (진행 가능)
- `completed`: 학습 완료 (모든 강 성공)
- `expired`: 기한 만료 (진행 불가, 조회만 가능)

---

### 3.4 학습 수행 및 결과

#### 📌 lesson_attempt (차시)

**테이블 설명**: 강좌 학습 시도 (차시)

| 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|--------|------------|------|--------|------|
| attempt_id | BIGINT | NO | AUTO_INCREMENT | 차시 ID (내부 PK) |
| attempt_uuid | BINARY(16) | NO | UUID_TO_BIN(UUID(), 1) | 차시 UUID (외부 API용) |
| user_id | BIGINT | NO | - | 사용자 ID (FK) |
| license_id | BIGINT | NO | - | 라이선스 ID (FK) |
| lesson_id | BIGINT | NO | - | 강좌 ID (FK) |
| attempt_number | INT | NO | - | 차시 번호 (1,2,3...) |
| result | ENUM('success','fail','in_progress') | NO | 'in_progress' | 결과 |
| started_at | DATETIME(6) | NO | - | 시작 일시 |
| completed_at | DATETIME(6) | YES | NULL | 완료 일시 |
| total_elapsed_time | INT | YES | NULL | 누적 학습 시간(초) |
| fail_reason | VARCHAR(100) | YES | NULL | 실패 사유 |
| created_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 생성 일시 |
| updated_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 수정 일시 |

**제약조건**:
- PRIMARY KEY (attempt_id)
- UNIQUE KEY uk_attempt_uuid (attempt_uuid)
- INDEX idx_attempt_uuid (attempt_uuid) COMMENT 'UUID 조회용'
- FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE
- FOREIGN KEY (license_id) REFERENCES license(license_id) ON DELETE CASCADE
- FOREIGN KEY (lesson_id) REFERENCES lesson(lesson_id) ON DELETE CASCADE
- INDEX idx_user_id (user_id)
- INDEX idx_user_lesson (user_id, lesson_id)
- INDEX idx_lesson_id (lesson_id)
- INDEX idx_started_at (started_at)

**fail_reason 예시**:
- "다시읽기 제한 시간 초과"
- "문제확인 모르는 문제 초과"
- "문제풀이 오답 문제 초과"

---

#### 📌 section_result (구간별 결과)

**테이블 설명**: 9개 학습 구간별 상세 결과

| 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|--------|------------|------|--------|------|
| result_id | BIGINT | NO | AUTO_INCREMENT | 결과 ID (내부 PK) |
| result_uuid | BINARY(16) | NO | UUID_TO_BIN(UUID(), 1) | 결과 UUID (외부 API용) |
| attempt_id | BIGINT | NO | - | 차시 ID (FK) |
| section_type | ENUM(...) | NO | - | 학습 구간 유형 |
| elapsed_time | INT | YES | NULL | 소요 시간(초) |
| reading_speed | INT | YES | NULL | 분당 글자 수 |
| unknown_question_count | INT | YES | NULL | 모르는 문제 개수 |
| correct_count | INT | YES | NULL | 정답 개수 |
| total_count | INT | YES | NULL | 전체 문항 수 |
| wrong_count | INT | YES | NULL | 오답 개수 |
| unknown_answer_count | INT | YES | NULL | 모름 선택 개수 |
| comprehension_score | DECIMAL(5,2) | YES | NULL | 이해도 점수 |
| story_order_attempts | INT | YES | NULL | 줄거리순서 시도 횟수 |
| story_order_result | ENUM(...) | YES | NULL | 줄거리순서 결과 |
| traffic_light | ENUM(...) | YES | NULL | 신호등 상태 |
| section_data | JSON | YES | NULL | 구간별 추가 데이터 |
| created_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 생성 일시 |

**section_type ENUM 값**:
```sql
'title_reading',      -- 제목읽기
'vocab_check',        -- 어휘확인
'passage_reading',    -- 지문읽기
'question_check',     -- 문제확인
're_reading',         -- 다시읽기
'problem_solving',    -- 문제풀이
'info_processing',    -- 정보처리
'story_order',        -- 줄거리순서
'vocab_problem'       -- 어휘문제
```

**traffic_light ENUM 값**:
```sql
'good',      -- 좋음
'normal',    -- 표준
'slow',      -- 느림
'fast',      -- 빠름
'bad',       -- 나쁨
'exceeded'   -- 제한 시간 초과
```

**story_order_result ENUM 값**:
```sql
'success_first',   -- 1회 성공
'success_second',  -- 2회 성공
'fail'             -- 2회 실패
```

**제약조건**:
- PRIMARY KEY (result_id)
- UNIQUE KEY uk_result_uuid (result_uuid)
- INDEX idx_result_uuid (result_uuid) COMMENT 'UUID 조회용'
- FOREIGN KEY (attempt_id) REFERENCES lesson_attempt(attempt_id) ON DELETE CASCADE
- INDEX idx_attempt_id (attempt_id)
- UNIQUE KEY uk_attempt_section (attempt_id, section_type)
- INDEX idx_section_type (section_type)

**section_data JSON 예시**:
```json
{
  "question_check": {
    "unknown_questions": [1, 3, 5],
    "highlighted_keywords": {
      "1": ["핵심어1", "핵심어2"],
      "2": ["핵심어3"]
    }
  },
  "problem_solving": {
    "answers": [1, 2, 0, 4, 5, 3],  // 0 = 모르겠어요
    "correct_answers": [1, 2, 3, 4, 5, 6],
    "is_critical": [false, false, false, false, false, true]
  },
  "info_processing": {
    "student_selections": {
      "1": [1, 2],
      "2": [5, 6]
    },
    "model_answer": {
      "1": [1, 2, 3],
      "2": [5, 6, 7]
    }
  }
}
```

---

### 3.5 어휘 관리

#### 📌 vocabulary (어휘)

**테이블 설명**: 강좌별 어휘 정보

| 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|--------|------------|------|--------|------|
| vocab_id | BIGINT | NO | AUTO_INCREMENT | 어휘 ID (내부 PK) |
| vocab_uuid | BINARY(16) | NO | UUID_TO_BIN(UUID(), 1) | 어휘 UUID (외부 API용) |
| lesson_id | BIGINT | NO | - | 강좌 ID (FK) |
| word | VARCHAR(100) | NO | - | 어휘 |
| meaning | TEXT | NO | - | 뜻 |
| example_sentence | TEXT | YES | NULL | 예문 |
| hint | TEXT | YES | NULL | 힌트 |
| display_order | INT | NO | - | 노출 순서 |
| tag_level2 | VARCHAR(50) | YES | NULL | 2차 태그 |
| tag_level3 | VARCHAR(50) | YES | NULL | 3차 태그 |
| vocab_type | ENUM('core','thinking','context') | YES | NULL | 핵심어/사고어/맥락어 |
| created_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 생성 일시 |

**제약조건**:
- PRIMARY KEY (vocab_id)
- UNIQUE KEY uk_vocab_uuid (vocab_uuid)
- INDEX idx_vocab_uuid (vocab_uuid) COMMENT 'UUID 조회용'
- FOREIGN KEY (lesson_id) REFERENCES lesson(lesson_id) ON DELETE CASCADE
- INDEX idx_lesson_id (lesson_id)
- INDEX idx_lesson_order (lesson_id, display_order)
- INDEX idx_word (word)

**vocab_type 정의**:
- `core`: 핵심어
- `thinking`: 사고어
- `context`: 맥락어

---

#### 📌 vocab_problem (어휘 문제)

**테이블 설명**: 어휘당 3개 문제 (우선순위별)

| 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|--------|------------|------|--------|------|
| problem_id | BIGINT | NO | AUTO_INCREMENT | 문제 ID (내부 PK) |
| problem_uuid | BINARY(16) | NO | UUID_TO_BIN(UUID(), 1) | 문제 UUID (외부 API용) |
| vocab_id | BIGINT | NO | - | 어휘 ID (FK) |
| priority | INT | NO | - | 우선순위 (1,2,3) |
| problem_type | VARCHAR(50) | YES | NULL | 문제 유형 |
| question | TEXT | NO | - | 문제 지문 |
| option_1 | VARCHAR(255) | YES | NULL | 보기 1 |
| option_2 | VARCHAR(255) | YES | NULL | 보기 2 |
| option_3 | VARCHAR(255) | YES | NULL | 보기 3 |
| option_4 | VARCHAR(255) | YES | NULL | 보기 4 |
| option_5 | VARCHAR(255) | YES | NULL | 보기 5 |
| option_6 | VARCHAR(255) | YES | NULL | 보기 6 |
| correct_answer | INT | NO | - | 정답 번호 (1~6) |
| created_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 생성 일시 |

**제약조건**:
- PRIMARY KEY (problem_id)
- UNIQUE KEY uk_problem_uuid (problem_uuid)
- INDEX idx_problem_uuid (problem_uuid) COMMENT 'UUID 조회용'
- FOREIGN KEY (vocab_id) REFERENCES vocabulary(vocab_id) ON DELETE CASCADE
- INDEX idx_vocab_id (vocab_id)
- INDEX idx_vocab_priority (vocab_id, priority)

**priority 정의**:
- `1`: 어휘문제 구간 출제
- `2`: 오늘의 어휘 / 테마 학습 출제
- `3`: 오늘의 어휘 / 테마 학습 출제

---

#### 📌 vocab_learning (어휘 학습 현황)

**테이블 설명**: 사용자별 어휘 아는/모르는 상태 관리

| 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|--------|------------|------|--------|------|
| learning_id | BIGINT | NO | AUTO_INCREMENT | 학습 ID (내부 PK) |
| learning_uuid | BINARY(16) | NO | UUID_TO_BIN(UUID(), 1) | 학습 UUID (외부 API용) |
| user_id | BIGINT | NO | - | 사용자 ID (FK) |
| vocab_id | BIGINT | NO | - | 어휘 ID (FK) |
| status | ENUM('known','unknown') | NO | - | 아는/모르는 어휘 |
| student_example | TEXT | YES | NULL | 학생 작성 예문 |
| last_correct_at | DATETIME(6) | YES | NULL | 마지막 정답 일시 |
| last_wrong_at | DATETIME(6) | YES | NULL | 마지막 오답 일시 |
| total_correct_count | INT | NO | 0 | 누적 정답 횟수 |
| total_wrong_count | INT | NO | 0 | 누적 오답 횟수 |
| created_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 생성 일시 |
| updated_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 수정 일시 |

**제약조건**:
- PRIMARY KEY (learning_id)
- UNIQUE KEY uk_learning_uuid (learning_uuid)
- INDEX idx_learning_uuid (learning_uuid) COMMENT 'UUID 조회용'
- FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE
- FOREIGN KEY (vocab_id) REFERENCES vocabulary(vocab_id) ON DELETE CASCADE
- INDEX idx_user_id (user_id)
- INDEX idx_vocab_id (vocab_id)
- UNIQUE KEY uk_user_vocab (user_id, vocab_id)
- INDEX idx_status (user_id, status)
- INDEX idx_last_correct (last_correct_at)

---

#### 📌 vocab_learning_result (어휘 학습 결과)

**테이블 설명**: 오늘의 어휘, 테마 학습 결과 이력

| 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|--------|------------|------|--------|------|
| result_id | BIGINT | NO | AUTO_INCREMENT | 결과 ID (내부 PK) |
| result_uuid | BINARY(16) | NO | UUID_TO_BIN(UUID(), 1) | 결과 UUID (외부 API용) |
| learning_id | BIGINT | NO | - | 학습 ID (FK) |
| learning_type | ENUM(...) | YES | NULL | 학습 유형 |
| lesson_ids | TEXT | YES | NULL | 선택 강좌 ID (JSON) |
| total_problems | INT | YES | NULL | 출제 문항 수 |
| correct_count | INT | YES | NULL | 정답 개수 |
| completed_at | DATETIME(6) | NO | - | 완료 일시 |
| created_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 생성 일시 |

**learning_type ENUM 값**:
```sql
'today_vocab',          -- 오늘의 어휘
'theme_my_select',      -- 내가 선택한 어휘
'theme_recent',         -- 최근 맞힌 어휘
'theme_recommend',      -- 추천 어휘
'theme_old'             -- 오랫동안 안 본 어휘
```

**제약조건**:
- PRIMARY KEY (result_id)
- UNIQUE KEY uk_result_uuid (result_uuid)
- INDEX idx_result_uuid (result_uuid) COMMENT 'UUID 조회용'
- FOREIGN KEY (learning_id) REFERENCES vocab_learning(learning_id) ON DELETE CASCADE
- INDEX idx_learning_id (learning_id)
- INDEX idx_completed_at (completed_at)

---

### 3.6 서술 요약

#### 📌 summary (서술 요약)

**테이블 설명**: 강좌별 학생 작성 요약

| 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|--------|------------|------|--------|------|
| summary_id | BIGINT | NO | AUTO_INCREMENT | 요약 ID (내부 PK) |
| summary_uuid | BINARY(16) | NO | UUID_TO_BIN(UUID(), 1) | 요약 UUID (외부 API용) |
| user_id | BIGINT | NO | - | 사용자 ID (FK) |
| lesson_id | BIGINT | NO | - | 강좌 ID (FK) |
| prompt_type | VARCHAR(50) | YES | NULL | 발문 유형 |
| hint | TEXT | YES | NULL | 힌트 내용 |
| model_answer | TEXT | YES | NULL | 모범 답안 |
| student_text | TEXT | YES | NULL | 학생 작성 요약 |
| ai_correction | TEXT | YES | NULL | AI 교정 내용 |
| is_completed | BOOLEAN | NO | FALSE | 작성 완료 여부 |
| completed_at | DATETIME(6) | YES | NULL | 작성 완료 일시 |
| created_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 생성 일시 |
| updated_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 수정 일시 |

**제약조건**:
- PRIMARY KEY (summary_id)
- UNIQUE KEY uk_summary_uuid (summary_uuid)
- INDEX idx_summary_uuid (summary_uuid) COMMENT 'UUID 조회용'
- FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE
- FOREIGN KEY (lesson_id) REFERENCES lesson(lesson_id) ON DELETE CASCADE
- INDEX idx_user_id (user_id)
- INDEX idx_lesson_id (lesson_id)
- UNIQUE KEY uk_user_lesson_summary (user_id, lesson_id)
- INDEX idx_completed (is_completed, completed_at)

**prompt_type 예시**:
- "type1": 지문 난이도별 발문 유형 1
- "type2": 지문 난이도별 발문 유형 2
- "type3": 지문 난이도별 발문 유형 3
- "type4": 지문 난이도별 발문 유형 4

---

### 3.7 퀘스트 시스템

#### 📌 quest_product (퀘스트 상품)

**테이블 설명**: 퀘스트 상품 정보 (디저트)

| 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|--------|------------|------|--------|------|
| product_id | BIGINT | NO | AUTO_INCREMENT | 상품 ID (내부 PK) |
| product_uuid | BINARY(16) | NO | UUID_TO_BIN(UUID(), 1) | 상품 UUID (외부 API용) |
| product_name | VARCHAR(100) | NO | - | 상품명 |
| product_image | VARCHAR(255) | YES | NULL | 상품 이미지 URL |
| ingredient_images | JSON | YES | NULL | 재료 이미지 목록 |
| created_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 생성 일시 |

**제약조건**:
- PRIMARY KEY (product_id)
- UNIQUE KEY uk_product_uuid (product_uuid)
- INDEX idx_product_uuid (product_uuid) COMMENT 'UUID 조회용'

**ingredient_images JSON 예시**:
```json
{
  "lesson_success": "재료1_이미지.png",
  "today_vocab": "재료2_이미지.png",
  "today_summary": "재료3_이미지.png",
  "theme_learning": "재료4_이미지.png"
}
```

---

#### 📌 quest (퀘스트)

**테이블 설명**: 사용자별 퀘스트 진행

| 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|--------|------------|------|--------|------|
| quest_id | BIGINT | NO | AUTO_INCREMENT | 퀘스트 ID (내부 PK) |
| quest_uuid | BINARY(16) | NO | UUID_TO_BIN(UUID(), 1) | 퀘스트 UUID (외부 API용) |
| user_id | BIGINT | NO | - | 사용자 ID (FK) |
| product_id | BIGINT | NO | - | 상품 ID (FK) |
| status | ENUM('in_progress','completed') | NO | 'in_progress' | 상태 |
| is_excellent | BOOLEAN | NO | FALSE | 우수 상품 여부 |
| selected_at | DATETIME(6) | NO | - | 상품 선택 일시 |
| completed_at | DATETIME(6) | YES | NULL | 상품 획득 일시 |
| created_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 생성 일시 |

**제약조건**:
- PRIMARY KEY (quest_id)
- UNIQUE KEY uk_quest_uuid (quest_uuid)
- INDEX idx_quest_uuid (quest_uuid) COMMENT 'UUID 조회용'
- FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE
- FOREIGN KEY (product_id) REFERENCES quest_product(product_id) ON DELETE RESTRICT
- INDEX idx_user_id (user_id)
- INDEX idx_user_status (user_id, status)
- INDEX idx_product_id (product_id)

---

#### 📌 quest_progress (퀘스트 진행 상황)

**테이블 설명**: 4가지 퀘스트 유형별 진행률

| 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|--------|------------|------|--------|------|
| progress_id | BIGINT | NO | AUTO_INCREMENT | 진행 ID (내부 PK) |
| progress_uuid | BINARY(16) | NO | UUID_TO_BIN(UUID(), 1) | 진행 UUID (외부 API용) |
| quest_id | BIGINT | NO | - | 퀘스트 ID (FK) |
| quest_type | ENUM(...) | NO | - | 퀘스트 유형 |
| completed_count | INT | NO | 0 | 완료 횟수 |
| target_count | INT | NO | - | 목표 횟수 |
| progress_rate | DECIMAL(5,2) | NO | 0.00 | 진행률 (%) |
| created_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 생성 일시 |
| updated_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 수정 일시 |

**quest_type ENUM 값**:
```sql
'lesson_success',    -- 강좌 성공 (목표: 10)
'today_vocab',       -- 오늘의 어휘 완료 (목표: 7)
'today_summary',     -- 오늘의 요약 완료 (목표: 7)
'theme_learning'     -- 테마 학습 1회 완료 (목표: 5)
```

**제약조건**:
- PRIMARY KEY (progress_id)
- UNIQUE KEY uk_progress_uuid (progress_uuid)
- INDEX idx_progress_uuid (progress_uuid) COMMENT 'UUID 조회용'
- FOREIGN KEY (quest_id) REFERENCES quest(quest_id) ON DELETE CASCADE
- INDEX idx_quest_id (quest_id)
- UNIQUE KEY uk_quest_type (quest_id, quest_type)

---

#### 📌 quest_history (퀘스트 이력)

**테이블 설명**: 퀘스트 활동 일자별 이력

| 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|--------|------------|------|--------|------|
| history_id | BIGINT | NO | AUTO_INCREMENT | 이력 ID (내부 PK) |
| history_uuid | BINARY(16) | NO | UUID_TO_BIN(UUID(), 1) | 이력 UUID (외부 API용) |
| quest_id | BIGINT | NO | - | 퀘스트 ID (FK) |
| quest_type | ENUM(...) | NO | - | 퀘스트 유형 |
| activity_date | DATE | NO | - | 활동 일자 |
| lesson_id | BIGINT | YES | NULL | 강좌 성공 시 lesson_id (FK) |
| created_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 생성 일시 |

**제약조건**:
- PRIMARY KEY (history_id)
- UNIQUE KEY uk_history_uuid (history_uuid)
- INDEX idx_history_uuid (history_uuid) COMMENT 'UUID 조회용'
- FOREIGN KEY (quest_id) REFERENCES quest(quest_id) ON DELETE CASCADE
- FOREIGN KEY (lesson_id) REFERENCES lesson(lesson_id) ON DELETE SET NULL
- INDEX idx_quest_id (quest_id)
- INDEX idx_quest_date (quest_id, activity_date)

**비즈니스 규칙**:
- 동일 날짜 동일 퀘스트 타입 중복 방지
- 테마 학습: 같은 날 여러 번 진행해도 1회만 기록

---

#### 📌 coupon (쿠폰)

**테이블 설명**: 퀘스트 완료 보상 쿠폰

| 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|--------|------------|------|--------|------|
| coupon_id | BIGINT | NO | AUTO_INCREMENT | 쿠폰 ID (내부 PK) |
| coupon_uuid | BINARY(16) | NO | UUID_TO_BIN(UUID(), 1) | 쿠폰 UUID (외부 API용) |
| user_id | BIGINT | NO | - | 사용자 ID (FK) |
| quest_id | BIGINT | YES | NULL | 퀘스트 ID (FK) |
| coupon_type | ENUM('excellent','normal') | NO | - | 우수/일반 쿠폰 |
| coupon_code | VARCHAR(50) | NO | - | 쿠폰 코드 (UNIQUE, 대소문자 구분) |
| discount_amount | DECIMAL(10,2) | YES | NULL | 할인 금액 |
| issued_at | DATETIME(6) | NO | - | 발급 일시 |
| expire_date | DATETIME(6) | YES | NULL | 만료 일자 |
| used_at | DATETIME(6) | YES | NULL | 사용 일시 |
| status | ENUM('available','used','expired') | NO | 'available' | 상태 |
| created_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 생성 일시 |

**제약조건**:
- PRIMARY KEY (coupon_id)
- UNIQUE KEY uk_coupon_uuid (coupon_uuid)
- INDEX idx_coupon_uuid (coupon_uuid) COMMENT 'UUID 조회용'
- FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE
- FOREIGN KEY (quest_id) REFERENCES quest(quest_id) ON DELETE SET NULL
- INDEX idx_user_id (user_id)
- UNIQUE KEY uk_coupon_code (coupon_code)
- INDEX idx_user_status (user_id, status)
- INDEX idx_expire_date (expire_date)

---

### 3.8 알림 시스템

#### 📌 notification (알림)

**테이블 설명**: 사용자 알림 관리

| 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|--------|------------|------|--------|------|
| notification_id | BIGINT | NO | AUTO_INCREMENT | 알림 ID (내부 PK) |
| notification_uuid | BINARY(16) | NO | UUID_TO_BIN(UUID(), 1) | 알림 UUID (외부 API용) |
| user_id | BIGINT | NO | - | 사용자 ID (FK) |
| type | ENUM(...) | NO | - | 알림 유형 |
| title | VARCHAR(255) | NO | - | 알림 제목 |
| content | TEXT | YES | NULL | 알림 내용 |
| related_id | VARCHAR(50) | YES | NULL | 관련 데이터 ID |
| is_read | BOOLEAN | NO | FALSE | 읽음 여부 |
| created_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 생성 일시 |
| read_at | DATETIME(6) | YES | NULL | 읽은 일시 |

**type ENUM 값**:
```sql
'gift_point',        -- 선물하기
'qna_answer',        -- QnA 답변 도착
'license_expire'     -- 라이선스 사용 기한
```

**제약조건**:
- PRIMARY KEY (notification_id)
- UNIQUE KEY uk_notification_uuid (notification_uuid)
- INDEX idx_notification_uuid (notification_uuid) COMMENT 'UUID 조회용'
- FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE
- INDEX idx_user_id (user_id)
- INDEX idx_user_read (user_id, is_read)
- INDEX idx_created_at (created_at DESC)

**related_id 용도**:
- gift_point: 선물 이력 ID
- qna_answer: QnA ID
- license_expire: license_id

---

### 3.9 로그 및 통계

#### 📌 activity_log (학습 활동 로그)

**테이블 설명**: 일자별 학습 활동 기록

| 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|--------|------------|------|--------|------|
| log_id | BIGINT | NO | AUTO_INCREMENT | 로그 ID (내부 PK) |
| log_uuid | BINARY(16) | NO | UUID_TO_BIN(UUID(), 1) | 로그 UUID (외부 API용) |
| user_id | BIGINT | NO | - | 사용자 ID (FK) |
| activity_type | ENUM(...) | NO | - | 활동 유형 |
| activity_date | DATE | NO | - | 활동 일자 |
| reference_id | VARCHAR(50) | YES | NULL | 참조 ID |
| created_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 생성 일시 |

**activity_type ENUM 값**:
```sql
'lesson',            -- 강좌 학습
'vocab_learning',    -- 어휘 학습
'summary'            -- 서술 요약
```

**제약조건**:
- PRIMARY KEY (log_id)
- UNIQUE KEY uk_log_uuid (log_uuid)
- INDEX idx_log_uuid (log_uuid) COMMENT 'UUID 조회용'
- FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE
- INDEX idx_user_id (user_id)
- INDEX idx_user_date (user_id, activity_date DESC)

**reference_id 용도**:
- lesson: attempt_id
- vocab_learning: learning_result_id
- summary: summary_id

---

#### 📌 volume_progress_cache (진행률 캐시)

**테이블 설명**: 권별 진행률 캐싱

| 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|--------|------------|------|--------|------|
| cache_id | BIGINT | NO | AUTO_INCREMENT | 캐시 ID (내부 PK) |
| cache_uuid | BINARY(16) | NO | UUID_TO_BIN(UUID(), 1) | 캐시 UUID (외부 API용) |
| user_id | BIGINT | NO | - | 사용자 ID (FK) |
| license_id | BIGINT | NO | - | 라이선스 ID (FK) |
| volume_id | BIGINT | NO | - | 권 ID (FK) |
| total_lessons | INT | NO | - | 총 강좌 수 |
| completed_lessons | INT | NO | 0 | 완료 강좌 수 |
| progress_rate | DECIMAL(5,2) | NO | 0.00 | 진행률 (%) |
| last_lesson_at | DATETIME(6) | YES | NULL | 마지막 학습 일시 |
| updated_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 수정 일시 |

**제약조건**:
- PRIMARY KEY (cache_id)
- UNIQUE KEY uk_cache_uuid (cache_uuid)
- INDEX idx_cache_uuid (cache_uuid) COMMENT 'UUID 조회용'
- FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE
- FOREIGN KEY (license_id) REFERENCES license(license_id) ON DELETE CASCADE
- FOREIGN KEY (volume_id) REFERENCES book_volume(volume_id) ON DELETE CASCADE
- INDEX idx_user_id (user_id)
- INDEX idx_license_id (license_id)
- INDEX idx_volume_id (volume_id)
- UNIQUE KEY uk_user_license_volume (user_id, license_id, volume_id)

---

#### 📌 daily_learning_stats (일별 학습 통계)

**테이블 설명**: 일별 학습 통계 집계

| 컬럼명 | 데이터 타입 | NULL | 기본값 | 설명 |
|--------|------------|------|--------|------|
| stat_id | BIGINT | NO | AUTO_INCREMENT | 통계 ID (내부 PK) |
| stat_uuid | BINARY(16) | NO | UUID_TO_BIN(UUID(), 1) | 통계 UUID (외부 API용) |
| user_id | BIGINT | NO | - | 사용자 ID (FK) |
| stat_date | DATE | NO | - | 통계 일자 |
| lesson_attempts | INT | NO | 0 | 강좌 시도 횟수 |
| lesson_success | INT | NO | 0 | 강좌 성공 횟수 |
| vocab_learning_count | INT | NO | 0 | 어휘 학습 횟수 |
| summary_completed | INT | NO | 0 | 요약 완료 개수 |
| total_study_time | INT | NO | 0 | 총 학습 시간(초) |
| created_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 생성 일시 |
| updated_at | DATETIME(6) | NO | CURRENT_TIMESTAMP(6) | 수정 일시 |

**제약조건**:
- PRIMARY KEY (stat_id)
- UNIQUE KEY uk_stat_uuid (stat_uuid)
- INDEX idx_stat_uuid (stat_uuid) COMMENT 'UUID 조회용'
- FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE
- INDEX idx_user_id (user_id)
- UNIQUE KEY uk_user_date (user_id, stat_date)
- INDEX idx_stat_date (stat_date)

---

## 4. 인덱스 설계

### 4.1 기본 인덱스 전략

**원칙**:
1. 모든 외래키에 인덱스 생성
2. 자주 조회되는 컬럼 조합에 복합 인덱스
3. 날짜 범위 조회용 인덱스
4. WHERE, JOIN, ORDER BY에 사용되는 컬럼 우선

### 4.2 주요 인덱스 목록

```sql
-- user 테이블
CREATE INDEX idx_name ON user(name);
CREATE INDEX idx_grade ON user(grade);

-- license 테이블
CREATE INDEX idx_user_status ON license(user_id, status);
CREATE INDEX idx_expire_date ON license(expire_date);

-- lesson_attempt 테이블
CREATE INDEX idx_user_lesson ON lesson_attempt(user_id, lesson_id);
CREATE INDEX idx_user_lesson_result ON lesson_attempt(user_id, lesson_id, result);
CREATE INDEX idx_started_at ON lesson_attempt(started_at);

-- section_result 테이블
CREATE INDEX idx_section_type ON section_result(section_type);
CREATE INDEX idx_attempt_type_time ON section_result(attempt_id, section_type, elapsed_time);

-- vocab_learning 테이블
CREATE INDEX idx_status ON vocab_learning(user_id, status);
CREATE INDEX idx_status_updated ON vocab_learning(user_id, status, updated_at);
CREATE INDEX idx_last_correct ON vocab_learning(last_correct_at);

-- activity_log 테이블
CREATE INDEX idx_user_date ON activity_log(user_id, activity_date DESC);
CREATE INDEX idx_user_type_date ON activity_log(user_id, activity_type, activity_date DESC);

-- notification 테이블
CREATE INDEX idx_user_read ON notification(user_id, is_read);
CREATE INDEX idx_created_at ON notification(created_at DESC);
```

### 4.3 커버링 인덱스 제안

```sql
-- 최근 학습 이력 조회 최적화
CREATE INDEX idx_user_lesson_complete ON lesson_attempt(
  user_id, 
  lesson_id, 
  result, 
  completed_at DESC
);

-- 어휘 학습 현황 조회 최적화
CREATE INDEX idx_vocab_status_date ON vocab_learning(
  user_id, 
  status, 
  last_correct_at DESC, 
  last_wrong_at DESC
);
```

---

## 5. DDL (Data Definition Language)

### 5.1 전체 DDL 스크립트

```sql
-- ============================================
-- 읽쓰 문해력 학습 플랫폼 데이터베이스
-- ============================================

-- 데이터베이스 생성
CREATE DATABASE IF NOT EXISTS icks_literacy
  DEFAULT CHARACTER SET utf8mb4
  DEFAULT COLLATE utf8mb4_0900_ai_ci;

USE icks_literacy;

-- ============================================
-- 1. 사용자 관리
-- ============================================

CREATE TABLE user (
  user_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '사용자 ID (내부 PK)',
  user_uuid BINARY(16) UNIQUE NOT NULL DEFAULT (UUID_TO_BIN(UUID(), 1)) COMMENT '사용자 UUID (외부 API용)',
  name VARCHAR(100) NOT NULL COMMENT '학생 이름',
  grade VARCHAR(20) COMMENT '학년 정보',
  user_type ENUM('student', 'admin') DEFAULT 'student' COMMENT '사용자 유형',
  profile_image VARCHAR(255) COMMENT '프로필 이미지 URL',
  created_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) COMMENT '생성 일시',
  updated_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6) COMMENT '수정 일시',
  INDEX idx_user_uuid (user_uuid) COMMENT 'UUID 조회용',
  INDEX idx_name (name),
  INDEX idx_grade (grade)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
COMMENT='사용자 정보';

-- ============================================
-- 2. 교재 및 강좌 메타데이터
-- ============================================

CREATE TABLE book_volume (
  volume_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '권 ID (내부 PK)',
  volume_uuid BINARY(16) UNIQUE NOT NULL DEFAULT (UUID_TO_BIN(UUID(), 1)) COMMENT '권 UUID (외부 API용)',
  volume_number INT NOT NULL UNIQUE COMMENT '권 번호 (1~15)',
  title VARCHAR(255) NOT NULL COMMENT '권 제목',
  stage ENUM('A', 'B', 'C') NOT NULL COMMENT '난이도 단계',
  total_lessons INT NOT NULL COMMENT '총 강좌 수 (12 or 15)',
  avg_word_count VARCHAR(50) COMMENT '평균 글자 수 범위',
  created_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) COMMENT '생성 일시',
  INDEX idx_volume_uuid (volume_uuid) COMMENT 'UUID 조회용',
  INDEX idx_volume_number (volume_number)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
COMMENT='권 메타데이터';

CREATE TABLE lesson (
  lesson_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '강좌 ID (내부 PK)',
  lesson_uuid BINARY(16) UNIQUE NOT NULL DEFAULT (UUID_TO_BIN(UUID(), 1)) COMMENT '강좌 UUID (외부 API용)',
  volume_id BIGINT NOT NULL COMMENT '권 ID (FK)',
  lesson_number INT NOT NULL COMMENT '강 번호',
  title VARCHAR(255) NOT NULL COMMENT '지문 제목',
  word_count INT COMMENT '지문 글자 수',
  content_image VARCHAR(255) COMMENT '제목읽기 이미지 URL',
  passage_text TEXT COMMENT '강좌 지문 내용',
  reading_target_time INT COMMENT '목표 읽기 시간(초)',
  reading_limit_time INT COMMENT '제한 읽기 시간(초)',
  re_reading_limit_time INT COMMENT '다시읽기 제한 시간(초)',
  created_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) COMMENT '생성 일시',
  INDEX idx_lesson_uuid (lesson_uuid) COMMENT 'UUID 조회용',
  INDEX idx_volume_id (volume_id) COMMENT '권별 조회',
  INDEX idx_lesson_number (lesson_number),
  UNIQUE KEY uk_volume_lesson (volume_id, lesson_number),
  FOREIGN KEY (volume_id) REFERENCES book_volume(volume_id) ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
COMMENT='강좌 정보';

-- ============================================
-- 3. 라이선스 관리
-- ============================================

CREATE TABLE license (
  license_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '라이선스 ID (내부 PK)',
  license_uuid BINARY(16) UNIQUE NOT NULL DEFAULT (UUID_TO_BIN(UUID(), 1)) COMMENT '라이선스 UUID (외부 API용)',
  user_id BIGINT NOT NULL COMMENT '사용자 ID (FK)',
  volume_id BIGINT NOT NULL COMMENT '권 ID (FK)',
  granted_at DATETIME(6) NOT NULL COMMENT '부여 일시',
  expire_date DATETIME(6) NOT NULL COMMENT '만료 일자 (부여 후 6개월)',
  status ENUM('active', 'completed', 'expired') DEFAULT 'active' COMMENT '상태: active(사용중), completed(학습완료), expired(기한만료)',
  created_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) COMMENT '생성 일시',
  updated_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6) COMMENT '수정 일시',
  INDEX idx_license_uuid (license_uuid) COMMENT 'UUID 조회용',
  INDEX idx_user_id (user_id) COMMENT '사용자별 조회',
  INDEX idx_user_status (user_id, status),
  INDEX idx_volume_id (volume_id) COMMENT '권별 조회',
  INDEX idx_expire_date (expire_date),
  FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE,
  FOREIGN KEY (volume_id) REFERENCES book_volume(volume_id) ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
COMMENT='라이선스';

-- ============================================
-- 4. 학습 수행 및 결과
-- ============================================

CREATE TABLE lesson_attempt (
  attempt_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '차시 ID (내부 PK)',
  attempt_uuid BINARY(16) UNIQUE NOT NULL DEFAULT (UUID_TO_BIN(UUID(), 1)) COMMENT '차시 UUID (외부 API용)',
  user_id BIGINT NOT NULL COMMENT '사용자 ID (FK)',
  license_id BIGINT NOT NULL COMMENT '라이선스 ID (FK)',
  lesson_id BIGINT NOT NULL COMMENT '강좌 ID (FK)',
  attempt_number INT NOT NULL COMMENT '차시 번호',
  result ENUM('success', 'fail', 'in_progress') DEFAULT 'in_progress' COMMENT '결과',
  started_at DATETIME(6) NOT NULL COMMENT '학습 시작 일시',
  completed_at DATETIME(6) COMMENT '학습 완료 일시',
  total_elapsed_time INT COMMENT '누적 학습 시간(초)',
  fail_reason VARCHAR(100) COMMENT '실패 사유 (탈락 구간)',
  created_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) COMMENT '생성 일시',
  updated_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6) COMMENT '수정 일시',
  INDEX idx_attempt_uuid (attempt_uuid) COMMENT 'UUID 조회용',
  INDEX idx_user_id (user_id) COMMENT '사용자별 조회',
  INDEX idx_license_id (license_id) COMMENT '라이선스별 조회',
  INDEX idx_lesson_id (lesson_id) COMMENT '강좌별 조회',
  INDEX idx_user_lesson (user_id, lesson_id),
  INDEX idx_started_at (started_at),
  FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE,
  FOREIGN KEY (license_id) REFERENCES license(license_id) ON DELETE CASCADE,
  FOREIGN KEY (lesson_id) REFERENCES lesson(lesson_id) ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
COMMENT='차시 수행';

CREATE TABLE section_result (
  result_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '결과 ID (내부 PK)',
  result_uuid BINARY(16) UNIQUE NOT NULL DEFAULT (UUID_TO_BIN(UUID(), 1)) COMMENT '결과 UUID (외부 API용)',
  attempt_id BIGINT NOT NULL COMMENT '차시 ID (FK)',
  section_type ENUM(
    'title_reading', 'vocab_check', 'passage_reading',
    'question_check', 're_reading', 'problem_solving',
    'info_processing', 'story_order', 'vocab_problem'
  ) NOT NULL COMMENT '학습 구간 유형',
  elapsed_time INT COMMENT '소요 시간(초)',
  reading_speed INT COMMENT '분당 글자 수 (읽기 구간)',
  unknown_question_count INT COMMENT '모르는 문제 개수 (문제확인)',
  correct_count INT COMMENT '정답 개수',
  total_count INT COMMENT '전체 문항 수',
  wrong_count INT COMMENT '오답 개수',
  unknown_answer_count INT COMMENT '모름 선택 개수',
  comprehension_score DECIMAL(5,2) COMMENT '이해도 점수',
  story_order_attempts INT COMMENT '줄거리순서 시도 횟수',
  story_order_result ENUM('success_first', 'success_second', 'fail') COMMENT '줄거리순서 결과',
  traffic_light ENUM('good', 'normal', 'slow', 'fast', 'bad', 'exceeded') COMMENT '신호등 상태',
  section_data JSON COMMENT '구간별 추가 세부 데이터',
  created_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) COMMENT '생성 일시',
  INDEX idx_result_uuid (result_uuid) COMMENT 'UUID 조회용',
  INDEX idx_attempt_id (attempt_id) COMMENT '차시별 조회',
  INDEX idx_section_type (section_type),
  UNIQUE KEY uk_attempt_section (attempt_id, section_type),
  FOREIGN KEY (attempt_id) REFERENCES lesson_attempt(attempt_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
COMMENT='구간별 결과';

-- ============================================
-- 5. 어휘 관리
-- ============================================

CREATE TABLE vocabulary (
  vocab_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '어휘 ID (내부 PK)',
  vocab_uuid BINARY(16) UNIQUE NOT NULL DEFAULT (UUID_TO_BIN(UUID(), 1)) COMMENT '어휘 UUID (외부 API용)',
  lesson_id BIGINT NOT NULL COMMENT '강좌 ID (FK)',
  word VARCHAR(100) NOT NULL COMMENT '어휘',
  meaning TEXT NOT NULL COMMENT '뜻',
  example_sentence TEXT COMMENT '예문',
  hint TEXT COMMENT '힌트',
  display_order INT NOT NULL COMMENT '노출 순서',
  tag_level2 VARCHAR(50) COMMENT '2차 태그',
  tag_level3 VARCHAR(50) COMMENT '3차 태그',
  vocab_type ENUM('core', 'thinking', 'context') COMMENT '핵심어/사고어/맥락어',
  created_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) COMMENT '생성 일시',
  INDEX idx_vocab_uuid (vocab_uuid) COMMENT 'UUID 조회용',
  INDEX idx_lesson_id (lesson_id) COMMENT '강좌별 조회',
  INDEX idx_lesson_order (lesson_id, display_order),
  INDEX idx_word (word),
  FOREIGN KEY (lesson_id) REFERENCES lesson(lesson_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
COMMENT='어휘 정보';

CREATE TABLE vocab_problem (
  problem_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '문제 ID (내부 PK)',
  problem_uuid BINARY(16) UNIQUE NOT NULL DEFAULT (UUID_TO_BIN(UUID(), 1)) COMMENT '문제 UUID (외부 API용)',
  vocab_id BIGINT NOT NULL COMMENT '어휘 ID (FK)',
  priority INT NOT NULL COMMENT '우선순위 (1,2,3)',
  problem_type VARCHAR(50) COMMENT '문제 유형',
  question TEXT NOT NULL COMMENT '문제 지문',
  option_1 VARCHAR(255) COMMENT '보기 1',
  option_2 VARCHAR(255) COMMENT '보기 2',
  option_3 VARCHAR(255) COMMENT '보기 3',
  option_4 VARCHAR(255) COMMENT '보기 4',
  option_5 VARCHAR(255) COMMENT '보기 5',
  option_6 VARCHAR(255) COMMENT '보기 6',
  correct_answer INT NOT NULL COMMENT '정답 번호 (1~6)',
  created_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) COMMENT '생성 일시',
  INDEX idx_problem_uuid (problem_uuid) COMMENT 'UUID 조회용',
  INDEX idx_vocab_id (vocab_id) COMMENT '어휘별 조회',
  INDEX idx_vocab_priority (vocab_id, priority),
  FOREIGN KEY (vocab_id) REFERENCES vocabulary(vocab_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
COMMENT='어휘 문제';

CREATE TABLE vocab_learning (
  learning_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '학습 ID (내부 PK)',
  learning_uuid BINARY(16) UNIQUE NOT NULL DEFAULT (UUID_TO_BIN(UUID(), 1)) COMMENT '학습 UUID (외부 API용)',
  user_id BIGINT NOT NULL COMMENT '사용자 ID (FK)',
  vocab_id BIGINT NOT NULL COMMENT '어휘 ID (FK)',
  status ENUM('known', 'unknown') NOT NULL COMMENT '아는 어휘/모르는 어휘',
  student_example TEXT COMMENT '학생이 작성한 예문',
  last_correct_at DATETIME(6) COMMENT '마지막 정답 일시',
  last_wrong_at DATETIME(6) COMMENT '마지막 오답 일시',
  total_correct_count INT DEFAULT 0 COMMENT '누적 정답 횟수',
  total_wrong_count INT DEFAULT 0 COMMENT '누적 오답 횟수',
  created_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) COMMENT '생성 일시',
  updated_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6) COMMENT '수정 일시',
  INDEX idx_learning_uuid (learning_uuid) COMMENT 'UUID 조회용',
  INDEX idx_user_id (user_id) COMMENT '사용자별 조회',
  INDEX idx_vocab_id (vocab_id) COMMENT '어휘별 조회',
  INDEX idx_status (user_id, status),
  INDEX idx_last_correct (last_correct_at),
  UNIQUE KEY uk_user_vocab (user_id, vocab_id),
  FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE,
  FOREIGN KEY (vocab_id) REFERENCES vocabulary(vocab_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
COMMENT='어휘 학습 현황';

CREATE TABLE vocab_learning_result (
  result_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '결과 ID (내부 PK)',
  result_uuid BINARY(16) UNIQUE NOT NULL DEFAULT (UUID_TO_BIN(UUID(), 1)) COMMENT '결과 UUID (외부 API용)',
  learning_id BIGINT NOT NULL COMMENT '학습 ID (FK)',
  learning_type ENUM('today_vocab', 'theme_my_select', 'theme_recent', 'theme_recommend', 'theme_old') COMMENT '학습 유형',
  lesson_ids TEXT COMMENT '선택한 강좌 ID 목록 (JSON array)',
  total_problems INT COMMENT '출제 문항 수',
  correct_count INT COMMENT '정답 개수',
  completed_at DATETIME(6) NOT NULL COMMENT '완료 일시',
  created_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) COMMENT '생성 일시',
  INDEX idx_result_uuid (result_uuid) COMMENT 'UUID 조회용',
  INDEX idx_learning_id (learning_id) COMMENT '학습별 조회',
  INDEX idx_completed_at (completed_at),
  FOREIGN KEY (learning_id) REFERENCES vocab_learning(learning_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
COMMENT='어휘 학습 결과';

-- ============================================
-- 6. 서술 요약
-- ============================================

CREATE TABLE summary (
  summary_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '요약 ID (내부 PK)',
  summary_uuid BINARY(16) UNIQUE NOT NULL DEFAULT (UUID_TO_BIN(UUID(), 1)) COMMENT '요약 UUID (외부 API용)',
  user_id BIGINT NOT NULL COMMENT '사용자 ID (FK)',
  lesson_id BIGINT NOT NULL COMMENT '강좌 ID (FK)',
  prompt_type VARCHAR(50) COMMENT '발문 유형 (지문 난이도별)',
  hint TEXT COMMENT '힌트 내용',
  model_answer TEXT COMMENT '모범 답안',
  student_text TEXT COMMENT '학생이 작성한 요약',
  ai_correction TEXT COMMENT 'AI 교정 내용',
  is_completed BOOLEAN DEFAULT FALSE COMMENT '작성 완료 여부',
  completed_at DATETIME(6) COMMENT '작성 완료 일시',
  created_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) COMMENT '생성 일시',
  updated_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6) COMMENT '수정 일시',
  INDEX idx_summary_uuid (summary_uuid) COMMENT 'UUID 조회용',
  INDEX idx_user_id (user_id) COMMENT '사용자별 조회',
  INDEX idx_lesson_id (lesson_id) COMMENT '강좌별 조회',
  INDEX idx_completed (is_completed, completed_at),
  UNIQUE KEY uk_user_lesson_summary (user_id, lesson_id),
  FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE,
  FOREIGN KEY (lesson_id) REFERENCES lesson(lesson_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
COMMENT='서술 요약';

-- ============================================
-- 7. 퀘스트 시스템
-- ============================================

CREATE TABLE quest_product (
  product_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '상품 ID (내부 PK)',
  product_uuid BINARY(16) UNIQUE NOT NULL DEFAULT (UUID_TO_BIN(UUID(), 1)) COMMENT '상품 UUID (외부 API용)',
  product_name VARCHAR(100) NOT NULL COMMENT '상품명 (디저트명)',
  product_image VARCHAR(255) COMMENT '상품 이미지 URL',
  ingredient_images JSON COMMENT '재료 이미지 목록',
  created_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) COMMENT '생성 일시',
  INDEX idx_product_uuid (product_uuid) COMMENT 'UUID 조회용'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
COMMENT='퀘스트 상품';

CREATE TABLE quest (
  quest_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '퀘스트 ID (내부 PK)',
  quest_uuid BINARY(16) UNIQUE NOT NULL DEFAULT (UUID_TO_BIN(UUID(), 1)) COMMENT '퀘스트 UUID (외부 API용)',
  user_id BIGINT NOT NULL COMMENT '사용자 ID (FK)',
  product_id BIGINT NOT NULL COMMENT '상품 ID (FK)',
  status ENUM('in_progress', 'completed') DEFAULT 'in_progress' COMMENT '상태',
  is_excellent BOOLEAN DEFAULT FALSE COMMENT '우수 상품 여부',
  selected_at DATETIME(6) NOT NULL COMMENT '상품 선택 일시',
  completed_at DATETIME(6) COMMENT '상품 획득 일시',
  created_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) COMMENT '생성 일시',
  INDEX idx_quest_uuid (quest_uuid) COMMENT 'UUID 조회용',
  INDEX idx_user_id (user_id) COMMENT '사용자별 조회',
  INDEX idx_product_id (product_id) COMMENT '상품별 조회',
  INDEX idx_user_status (user_id, status),
  FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE,
  FOREIGN KEY (product_id) REFERENCES quest_product(product_id) ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
COMMENT='퀘스트';

CREATE TABLE quest_progress (
  progress_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '진행 ID (내부 PK)',
  progress_uuid BINARY(16) UNIQUE NOT NULL DEFAULT (UUID_TO_BIN(UUID(), 1)) COMMENT '진행 UUID (외부 API용)',
  quest_id BIGINT NOT NULL COMMENT '퀘스트 ID (FK)',
  quest_type ENUM('lesson_success', 'today_vocab', 'today_summary', 'theme_learning') NOT NULL COMMENT '퀘스트 유형',
  completed_count INT DEFAULT 0 COMMENT '완료 횟수',
  target_count INT NOT NULL COMMENT '목표 횟수 (10,7,7,5)',
  progress_rate DECIMAL(5,2) DEFAULT 0.00 COMMENT '진행률 (%)',
  created_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) COMMENT '생성 일시',
  updated_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6) COMMENT '수정 일시',
  INDEX idx_progress_uuid (progress_uuid) COMMENT 'UUID 조회용',
  INDEX idx_quest_id (quest_id) COMMENT '퀘스트별 조회',
  UNIQUE KEY uk_quest_type (quest_id, quest_type),
  FOREIGN KEY (quest_id) REFERENCES quest(quest_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
COMMENT='퀘스트 진행 상황';

CREATE TABLE quest_history (
  history_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '이력 ID (내부 PK)',
  history_uuid BINARY(16) UNIQUE NOT NULL DEFAULT (UUID_TO_BIN(UUID(), 1)) COMMENT '이력 UUID (외부 API용)',
  quest_id BIGINT NOT NULL COMMENT '퀘스트 ID (FK)',
  quest_type ENUM('lesson_success', 'today_vocab', 'today_summary', 'theme_learning') NOT NULL COMMENT '퀘스트 유형',
  activity_date DATE NOT NULL COMMENT '활동 일자',
  lesson_id BIGINT COMMENT '강좌 성공 시 lesson_id (FK)',
  created_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) COMMENT '생성 일시',
  INDEX idx_history_uuid (history_uuid) COMMENT 'UUID 조회용',
  INDEX idx_quest_id (quest_id) COMMENT '퀘스트별 조회',
  INDEX idx_quest_date (quest_id, activity_date),
  FOREIGN KEY (quest_id) REFERENCES quest(quest_id) ON DELETE CASCADE,
  FOREIGN KEY (lesson_id) REFERENCES lesson(lesson_id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
COMMENT='퀘스트 이력';

CREATE TABLE coupon (
  coupon_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '쿠폰 ID (내부 PK)',
  coupon_uuid BINARY(16) UNIQUE NOT NULL DEFAULT (UUID_TO_BIN(UUID(), 1)) COMMENT '쿠폰 UUID (외부 API용)',
  user_id BIGINT NOT NULL COMMENT '사용자 ID (FK)',
  quest_id BIGINT COMMENT '퀘스트 ID (FK)',
  coupon_type ENUM('excellent', 'normal') NOT NULL COMMENT '우수/일반 쿠폰',
  coupon_code VARCHAR(50) COLLATE utf8mb4_bin UNIQUE NOT NULL COMMENT '쿠폰 코드 (대소문자 구분)',
  discount_amount DECIMAL(10,2) COMMENT '할인 금액',
  issued_at DATETIME(6) NOT NULL COMMENT '발급 일시',
  expire_date DATETIME(6) COMMENT '만료 일자',
  used_at DATETIME(6) COMMENT '사용 일시',
  status ENUM('available', 'used', 'expired') DEFAULT 'available' COMMENT '상태',
  created_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) COMMENT '생성 일시',
  INDEX idx_coupon_uuid (coupon_uuid) COMMENT 'UUID 조회용',
  INDEX idx_user_id (user_id) COMMENT '사용자별 조회',
  INDEX idx_quest_id (quest_id) COMMENT '퀘스트별 조회',
  INDEX idx_user_status (user_id, status),
  INDEX idx_expire_date (expire_date),
  FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE,
  FOREIGN KEY (quest_id) REFERENCES quest(quest_id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
COMMENT='쿠폰';

-- ============================================
-- 8. 알림 관리
-- ============================================

CREATE TABLE notification (
  notification_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '알림 ID (내부 PK)',
  notification_uuid BINARY(16) UNIQUE NOT NULL DEFAULT (UUID_TO_BIN(UUID(), 1)) COMMENT '알림 UUID (외부 API용)',
  user_id BIGINT NOT NULL COMMENT '사용자 ID (FK)',
  type ENUM('gift_point', 'qna_answer', 'license_expire') NOT NULL COMMENT '알림 유형',
  title VARCHAR(255) NOT NULL COMMENT '알림 제목',
  content TEXT COMMENT '알림 내용',
  related_id BIGINT COMMENT '관련 데이터 ID (선물/QnA/라이선스)',
  is_read BOOLEAN DEFAULT FALSE COMMENT '읽음 여부',
  created_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) COMMENT '생성 일시',
  read_at DATETIME(6) COMMENT '읽은 일시',
  INDEX idx_notification_uuid (notification_uuid) COMMENT 'UUID 조회용',
  INDEX idx_user_id (user_id) COMMENT '사용자별 조회',
  INDEX idx_user_read (user_id, is_read),
  INDEX idx_created_at (created_at DESC),
  FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
COMMENT='알림';

-- ============================================
-- 9. 학습 활동 로그
-- ============================================

CREATE TABLE activity_log (
  log_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '로그 ID (내부 PK)',
  log_uuid BINARY(16) UNIQUE NOT NULL DEFAULT (UUID_TO_BIN(UUID(), 1)) COMMENT '로그 UUID (외부 API용)',
  user_id BIGINT NOT NULL COMMENT '사용자 ID (FK)',
  activity_type ENUM('lesson', 'vocab_learning', 'summary') NOT NULL COMMENT '활동 유형',
  activity_date DATE NOT NULL COMMENT '활동 일자',
  reference_id BIGINT COMMENT '참조 ID (attempt_id, learning_result_id, summary_id)',
  created_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) COMMENT '생성 일시',
  INDEX idx_log_uuid (log_uuid) COMMENT 'UUID 조회용',
  INDEX idx_user_id (user_id) COMMENT '사용자별 조회',
  INDEX idx_user_date (user_id, activity_date DESC),
  FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
COMMENT='학습 활동 로그';

-- ============================================
-- 10. 캐시 및 통계
-- ============================================

CREATE TABLE volume_progress_cache (
  cache_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '캐시 ID (내부 PK)',
  cache_uuid BINARY(16) UNIQUE NOT NULL DEFAULT (UUID_TO_BIN(UUID(), 1)) COMMENT '캐시 UUID (외부 API용)',
  user_id BIGINT NOT NULL COMMENT '사용자 ID (FK)',
  license_id BIGINT NOT NULL COMMENT '라이선스 ID (FK)',
  volume_id BIGINT NOT NULL COMMENT '권 ID (FK)',
  total_lessons INT NOT NULL COMMENT '총 강좌 수',
  completed_lessons INT DEFAULT 0 COMMENT '완료 강좌 수',
  progress_rate DECIMAL(5,2) DEFAULT 0.00 COMMENT '진행률 (%)',
  last_lesson_at DATETIME(6) COMMENT '마지막 학습 일시',
  updated_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6) COMMENT '수정 일시',
  INDEX idx_cache_uuid (cache_uuid) COMMENT 'UUID 조회용',
  INDEX idx_user_id (user_id) COMMENT '사용자별 조회',
  INDEX idx_license_id (license_id) COMMENT '라이선스별 조회',
  INDEX idx_volume_id (volume_id) COMMENT '권별 조회',
  UNIQUE KEY uk_user_license_volume (user_id, license_id, volume_id),
  FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE,
  FOREIGN KEY (license_id) REFERENCES license(license_id) ON DELETE CASCADE,
  FOREIGN KEY (volume_id) REFERENCES book_volume(volume_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
COMMENT='권별 진행률 캐시';

CREATE TABLE daily_learning_stats (
  stat_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '통계 ID (내부 PK)',
  stat_uuid BINARY(16) UNIQUE NOT NULL DEFAULT (UUID_TO_BIN(UUID(), 1)) COMMENT '통계 UUID (외부 API용)',
  user_id BIGINT NOT NULL COMMENT '사용자 ID (FK)',
  stat_date DATE NOT NULL COMMENT '통계 일자',
  lesson_attempts INT DEFAULT 0 COMMENT '강좌 시도 횟수',
  lesson_success INT DEFAULT 0 COMMENT '강좌 성공 횟수',
  vocab_learning_count INT DEFAULT 0 COMMENT '어휘 학습 횟수',
  summary_completed INT DEFAULT 0 COMMENT '요약 완료 개수',
  total_study_time INT DEFAULT 0 COMMENT '총 학습 시간(초)',
  created_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) COMMENT '생성 일시',
  updated_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6) COMMENT '수정 일시',
  INDEX idx_stat_uuid (stat_uuid) COMMENT 'UUID 조회용',
  INDEX idx_user_id (user_id) COMMENT '사용자별 조회',
  INDEX idx_stat_date (stat_date),
  UNIQUE KEY uk_user_date (user_id, stat_date),
  FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
COMMENT='일별 학습 통계';
```

---

## 6. 확장 설계

### 6.1 사용자 행동 로그

```sql
CREATE TABLE user_behavior_log (
  log_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '로그 ID (내부 PK)',
  log_uuid BINARY(16) UNIQUE NOT NULL DEFAULT (UUID_TO_BIN(UUID(), 1)) COMMENT '로그 UUID (외부 API용)',
  user_id BIGINT NOT NULL COMMENT '사용자 ID (FK)',
  session_id BIGINT COMMENT '세션 ID',
  event_type VARCHAR(50) NOT NULL COMMENT 'page_view, button_click, section_start, section_end',
  event_target VARCHAR(100) COMMENT '이벤트 대상 (버튼명, 페이지명)',
  event_data JSON COMMENT '추가 이벤트 데이터',
  timestamp DATETIME(6) NOT NULL COMMENT '이벤트 발생 일시',
  INDEX idx_log_uuid (log_uuid) COMMENT 'UUID 조회용',
  INDEX idx_user_id (user_id) COMMENT '사용자별 조회',
  INDEX idx_user_timestamp (user_id, timestamp),
  INDEX idx_event_type (event_type),
  FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
COMMENT='사용자 행동 로그';
```

### 6.2 AI 학습 피처

```sql
CREATE TABLE learning_feature (
  feature_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '피처 ID (내부 PK)',
  feature_uuid BINARY(16) UNIQUE NOT NULL DEFAULT (UUID_TO_BIN(UUID(), 1)) COMMENT '피처 UUID (외부 API용)',
  user_id BIGINT NOT NULL COMMENT '사용자 ID (FK)',
  feature_date DATE NOT NULL COMMENT '피처 일자',
  avg_reading_speed DECIMAL(8,2) COMMENT '평균 읽기 속도',
  avg_comprehension DECIMAL(5,2) COMMENT '평균 이해도',
  weak_vocab_types JSON COMMENT '취약 어휘 유형 목록',
  weak_question_types JSON COMMENT '취약 문제 유형',
  study_pattern JSON COMMENT '학습 패턴 (요일별, 시간대별)',
  created_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) COMMENT '생성 일시',
  INDEX idx_feature_uuid (feature_uuid) COMMENT 'UUID 조회용',
  INDEX idx_user_id (user_id) COMMENT '사용자별 조회',
  UNIQUE KEY uk_user_date (user_id, feature_date),
  FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
COMMENT='AI 학습 피처';
```

### 6.3 사용자 피드백

```sql
CREATE TABLE user_feedback (
  feedback_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '피드백 ID (내부 PK)',
  feedback_uuid BINARY(16) UNIQUE NOT NULL DEFAULT (UUID_TO_BIN(UUID(), 1)) COMMENT '피드백 UUID (외부 API용)',
  user_id BIGINT NOT NULL COMMENT '사용자 ID (FK)',
  feedback_type ENUM('difficulty', 'satisfaction', 'recommendation') NOT NULL COMMENT '피드백 유형',
  target_type ENUM('lesson', 'vocab', 'summary') NOT NULL COMMENT '대상 유형',
  target_id BIGINT NOT NULL COMMENT '대상 ID (lesson_id, vocab_id, summary_id)',
  rating INT COMMENT '평점 (1~5)',
  comment TEXT COMMENT '의견',
  created_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) COMMENT '생성 일시',
  INDEX idx_feedback_uuid (feedback_uuid) COMMENT 'UUID 조회용',
  INDEX idx_user_id (user_id) COMMENT '사용자별 조회',
  INDEX idx_user_target (user_id, target_type, target_id),
  FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
COMMENT='사용자 피드백';
```

### 6.4 문제 변경 이력

```sql
CREATE TABLE vocab_problem_history (
  history_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '이력 ID (내부 PK)',
  history_uuid BINARY(16) UNIQUE NOT NULL DEFAULT (UUID_TO_BIN(UUID(), 1)) COMMENT '이력 UUID (외부 API용)',
  problem_id BIGINT NOT NULL COMMENT '문제 ID (FK)',
  version INT NOT NULL COMMENT '버전',
  changed_field VARCHAR(50) COMMENT '변경 필드',
  old_value TEXT COMMENT '이전 값',
  new_value TEXT COMMENT '새 값',
  changed_by BIGINT COMMENT '변경자 (admin user_id, FK)',
  changed_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) COMMENT '변경 일시',
  INDEX idx_history_uuid (history_uuid) COMMENT 'UUID 조회용',
  INDEX idx_problem_version (problem_id, version DESC),
  FOREIGN KEY (problem_id) REFERENCES vocab_problem(problem_id) ON DELETE CASCADE,
  FOREIGN KEY (changed_by) REFERENCES user(user_id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
COMMENT='문제 변경 이력';
```

### 6.5 파티셔닝 전략

```sql
-- activity_log 월별 파티셔닝
ALTER TABLE activity_log 
PARTITION BY RANGE (TO_DAYS(activity_date)) (
  PARTITION p202501 VALUES LESS THAN (TO_DAYS('2025-02-01')),
  PARTITION p202502 VALUES LESS THAN (TO_DAYS('2025-03-01')),
  PARTITION p202503 VALUES LESS THAN (TO_DAYS('2025-04-01')),
  PARTITION p_future VALUES LESS THAN MAXVALUE
);

-- user_behavior_log 월별 파티셔닝
ALTER TABLE user_behavior_log
PARTITION BY RANGE (TO_DAYS(DATE(timestamp))) (
  PARTITION p202501 VALUES LESS THAN (TO_DAYS('2025-02-01')),
  PARTITION p202502 VALUES LESS THAN (TO_DAYS('2025-03-01')),
  PARTITION p202503 VALUES LESS THAN (TO_DAYS('2025-04-01')),
  PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

---

## 7. 데이터 마이그레이션

### 7.1 초기 데이터 삽입

#### 권(book_volume) 초기 데이터

```sql
-- A단계 (1~5권)
-- volume_id는 AUTO_INCREMENT, volume_uuid는 DEFAULT로 자동 생성
INSERT INTO book_volume (volume_number, title, stage, total_lessons, avg_word_count) VALUES
(1, '1권', 'A', 12, '1~3'),
(2, '2권', 'A', 12, '1~3'),
(3, '3권', 'A', 12, '1~3'),
(4, '4권', 'A', 12, '4~5'),
(5, '5권', 'A', 12, '4~5');

-- B단계 (6~10권)
INSERT INTO book_volume (volume_number, title, stage, total_lessons, avg_word_count) VALUES
(6, '6권', 'B', 15, '6~8'),
(7, '7권', 'B', 15, '6~8'),
(8, '8권', 'B', 15, '6~8'),
(9, '9권', 'B', 15, '9~10'),
(10, '10권', 'B', 15, '9~10');

-- C단계 (11~15권)
INSERT INTO book_volume (volume_number, title, stage, total_lessons, avg_word_count) VALUES
(11, '11권', 'C', 12, '11~15'),
(12, '12권', 'C', 12, '11~15'),
(13, '13권', 'C', 12, '11~15'),
(14, '14권', 'C', 12, '11~15'),
(15, '15권', 'C', 12, '11~15');
```

#### 퀘스트 상품(quest_product) 초기 데이터

```sql
-- product_id는 AUTO_INCREMENT, product_uuid는 DEFAULT로 자동 생성
INSERT INTO quest_product (product_name, product_image, ingredient_images) VALUES
('빙수', 'bingsu.png', JSON_OBJECT(
  'lesson_success', 'ice.png',
  'today_vocab', 'syrup.png',
  'today_summary', 'fruit.png',
  'theme_learning', 'topping.png'
)),
('케이크', 'cake.png', JSON_OBJECT(
  'lesson_success', 'bread.png',
  'today_vocab', 'cream.png',
  'today_summary', 'strawberry.png',
  'theme_learning', 'candle.png'
));
```

### 7.2 백업 전략

```sql
-- 전체 백업
mysqldump -u root -p icks_literacy > icks_literacy_backup_YYYYMMDD.sql

-- 테이블별 백업
mysqldump -u root -p icks_literacy lesson_attempt section_result > attempt_backup_YYYYMMDD.sql

-- 데이터만 백업 (구조 제외)
mysqldump -u root -p --no-create-info icks_literacy > data_backup_YYYYMMDD.sql
```

---

## 📚 부록

### A. 데이터 타입 정의 가이드

| 용도 | 데이터 타입 | 비고 |
|------|------------|------|
| 기본키 (내부) | BIGINT AUTO_INCREMENT | 순차적 숫자 ID (내부 성능 최적화) |
| UUID (외부 API) | BINARY(16) UNIQUE | UUID, 외부 노출용 |
| 외래키 | BIGINT | BIGINT PK 참조 |
| 이름/제목 | VARCHAR(100~255) | 가변 길이 |
| 긴 텍스트 | TEXT | 65,535자 |
| 정수 | INT | 시간(초), 개수 등 |
| 큰 정수 | BIGINT | 8바이트 정수, PK/FK용 |
| 소수 | DECIMAL(5,2) | 이해도, 진행률 |
| 날짜/시간 | DATETIME(6) | 마이크로초 |
| 날짜만 | DATE | YYYY-MM-DD |
| JSON | JSON | 가변 구조 데이터 |
| ENUM | ENUM(...) | 정해진 값 목록 |
| 참/거짓 | BOOLEAN | TRUE/FALSE |

### B. 네이밍 컨벤션

```yaml
테이블명: snake_case (소문자, 언더스코어)
  예: lesson_attempt, vocab_learning

컬럼명: snake_case (소문자, 언더스코어)
  예: user_id, created_at

인덱스명:
  - 일반: idx_{컬럼명}
  - 복합: idx_{컬럼1}_{컬럼2}
  - 유니크: uk_{컬럼명}

외래키명:
  - fk_{테이블명}_{컬럼명}
```

### C. BIGINT PK + UUID 쿼리 가이드

#### 기본 개념

```sql
-- 내부 PK: BIGINT AUTO_INCREMENT (빠른 JOIN, 내부 참조용)
-- 외부 UUID: BINARY(16) UNIQUE (API 노출용, 보안)

-- 예시 테이블 구조
CREATE TABLE user (
  user_id BIGINT AUTO_INCREMENT PRIMARY KEY,        -- 내부 PK
  user_uuid BINARY(16) UNIQUE NOT NULL,             -- 외부 UUID
  name VARCHAR(100),
  INDEX idx_user_uuid (user_uuid)
);
```

#### UUID 생성 및 변환

```sql
-- 1. UUID 생성 (문자열)
SELECT UUID();
-- 결과: '550e8400-e29b-41d4-a716-446655440000'

-- 2. UUID → BINARY 변환 (저장용)
SELECT UUID_TO_BIN('550e8400-e29b-41d4-a716-446655440000', 1);
-- 결과: 0x550ee29b41d4a716446655440000e284 (16 bytes)

-- 3. BINARY → UUID 변환 (API 응답용)
SELECT BIN_TO_UUID(user_uuid, 1) as user_uuid FROM user;
-- 결과: '550e8400-e29b-41d4-a716-446655440000'
```

#### INSERT 쿼리

```sql
-- 방법 1: DEFAULT 값 사용 (권장)
INSERT INTO user (name, grade, user_type)
VALUES ('홍길동', '초등3', 'student');
-- user_id: AUTO_INCREMENT 자동 생성
-- user_uuid: DEFAULT (UUID_TO_BIN(UUID(), 1)) 자동 생성

-- 방법 2: 외래키 삽입 (내부 BIGINT 사용)
INSERT INTO license (user_id, volume_id, granted_at, expire_date)
VALUES (1, 5, NOW(6), DATE_ADD(NOW(6), INTERVAL 6 MONTH));
-- user_id는 BIGINT FK, UUID 아님
```

#### SELECT 쿼리

```sql
-- 1. 내부 쿼리 (BIGINT PK 사용, 빠름)
SELECT user_id, name, grade
FROM user
WHERE user_id = 1;

-- 2. 외부 API 쿼리 (UUID 사용, 보안)
SELECT
  user_id,                                -- 내부용 (필요시)
  BIN_TO_UUID(user_uuid, 1) as user_uuid, -- API 응답용
  name,
  grade
FROM user
WHERE user_uuid = UUID_TO_BIN('550e8400-e29b-41d4-a716-446655440000', 1);

-- 3. JOIN 쿼리 (내부 BIGINT 사용, 최적 성능)
SELECT
  u.user_id,
  BIN_TO_UUID(u.user_uuid, 1) as user_uuid,
  u.name,
  la.attempt_id,
  BIN_TO_UUID(la.attempt_uuid, 1) as attempt_uuid,
  la.result
FROM user u
JOIN lesson_attempt la ON u.user_id = la.user_id  -- BIGINT JOIN (빠름)
WHERE u.user_id = 1;

-- 4. 외부 API에서 UUID로 JOIN
SELECT
  BIN_TO_UUID(u.user_uuid, 1) as user_uuid,
  u.name,
  BIN_TO_UUID(la.attempt_uuid, 1) as attempt_uuid,
  la.result
FROM user u
JOIN lesson_attempt la ON u.user_id = la.user_id
WHERE u.user_uuid = UUID_TO_BIN('550e8400-e29b-41d4-a716-446655440000', 1);
```

#### UPDATE/DELETE 쿼리

```sql
-- 내부 시스템: BIGINT 사용
UPDATE user
SET name = '이영희'
WHERE user_id = 1;

-- 외부 API: UUID 사용
UPDATE user
SET name = '이영희'
WHERE user_uuid = UUID_TO_BIN('550e8400-e29b-41d4-a716-446655440000', 1);

-- DELETE (마찬가지)
DELETE FROM user
WHERE user_id = 1;  -- 내부용

DELETE FROM user
WHERE user_uuid = UUID_TO_BIN('550e8400-e29b-41d4-a716-446655440000', 1);  -- API용
```

#### 애플리케이션 계층 패턴

```sql
-- 권장 패턴:
-- 1. 외부 API: UUID 수신 → UUID로 조회 → UUID 반환
-- 2. 내부 로직: BIGINT PK로 조회 및 JOIN
-- 3. 외래키: 항상 BIGINT 사용

-- 예시: API 엔드포인트
-- GET /api/users/:user_uuid
SELECT
  BIN_TO_UUID(user_uuid, 1) as user_uuid,
  name,
  grade
FROM user
WHERE user_uuid = UUID_TO_BIN(:user_uuid, 1);

-- 예시: 내부 백그라운드 작업
SELECT user_id, name
FROM user
WHERE user_id IN (1, 2, 3, 4, 5);  -- BIGINT 배열, 빠름
```

#### 성능 최적화 팁

```sql
-- 1. JOIN은 항상 BIGINT PK/FK 사용 (40-50% 빠름)
SELECT *
FROM user u
JOIN lesson_attempt la ON u.user_id = la.user_id  -- BIGINT JOIN
WHERE u.user_id = 1;

-- 2. UUID는 외부 API 진입점에서만 사용
-- WHERE 절에서 user_uuid 조회 시 idx_user_uuid 인덱스 활용

-- 3. EXPLAIN으로 실행 계획 확인
EXPLAIN SELECT * FROM lesson_attempt
WHERE user_id = 1  -- BIGINT PK 조회
AND result = 'success';

-- 4. 슬로우 쿼리 로그 활성화
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 2;

-- 5. JSON 컬럼 쿼리
SELECT * FROM section_result
WHERE section_data->>'$.question_check.unknown_questions' LIKE '%[1,3]%';
```

#### 마이그레이션 가이드 (UUID PK → BIGINT PK + UUID UNIQUE)

```sql
-- 기존 UUID BINARY(16) PK를 BIGINT PK + UUID UNIQUE로 변환

-- 1. 새로운 BIGINT PK 컬럼 추가
ALTER TABLE user ADD COLUMN user_id_new BIGINT AUTO_INCREMENT UNIQUE;

-- 2. 기존 UUID PK를 UUID 컬럼으로 변경
ALTER TABLE user DROP PRIMARY KEY;
ALTER TABLE user CHANGE COLUMN user_id user_uuid BINARY(16) UNIQUE NOT NULL;

-- 3. 새 BIGINT를 PK로 설정
ALTER TABLE user CHANGE COLUMN user_id_new user_id BIGINT AUTO_INCREMENT PRIMARY KEY;

-- 4. UUID 인덱스 추가
ALTER TABLE user ADD INDEX idx_user_uuid (user_uuid);

-- 5. 외래키 업데이트 (다른 테이블들도 동일하게 진행)
-- license 테이블 예시:
ALTER TABLE license ADD COLUMN user_id_new BIGINT;
UPDATE license l
JOIN user u ON l.user_id = u.user_uuid
SET l.user_id_new = u.user_id;
ALTER TABLE license DROP FOREIGN KEY fk_license_user;
ALTER TABLE license DROP COLUMN user_id;
ALTER TABLE license CHANGE COLUMN user_id_new user_id BIGINT NOT NULL;
ALTER TABLE license ADD FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE;

-- 주의: 모든 외래키 참조를 순차적으로 변경 필요
```

---

**문서 변경 이력**
- v1.2 (2025-10-24): BIGINT AUTO_INCREMENT PK + UUID BINARY(16) UNIQUE 하이브리드 설계로 전환
- v1.1 (2025-10-23): UUID BINARY(16) 마이그레이션, 콜레이션 utf8mb4_0900_ai_ci 변경
- v1.0 (2025-10-23): 초안 작성

**관련 문서**
- 프로젝트 분석 보고서: `01_프로젝트_분석_보고서.md`
- 기능 정의서: `02_기능_정의서.md`
